{
  "article": {
    "id": 30952244573337,
    "url": "https://mackerelio.zendesk.com/api/v2/help_center/ja/articles/30952244573337.json",
    "html_url": "https://support.mackerel.io/hc/ja/articles/30952244573337",
    "author_id": 1900158221828,
    "comments_disabled": false,
    "draft": false,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 360008120511,
    "created_at": "2024-04-08T08:35:59Z",
    "updated_at": "2024-10-11T09:03:29Z",
    "name": "ホストが登録されない（mackerel-agent）",
    "title": "ホストが登録されない（mackerel-agent）",
    "source_locale": "ja",
    "locale": "ja",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-10-11T09:03:28Z",
    "user_segment_id": null,
    "permission_group_id": 1305671,
    "content_tag_ids": [],
    "label_names": [],
    "body": "<p>サーバーに mackerel-agent をインストールしてもホストが登録されない場合は、このページの内容を確認してください。</p>\n<h2 id=\"h_01J9XD23B0MCBJ1VC4YCH1X6V4\">mackerel-agent が起動しているか</h2>\n<p>mackerel-agent のサービスが起動しているか確認してください。サービスが起動していない場合は起動をお試しください。</p>\n<h3 id=\"h_01J9XD23B0J2SWJ16GPM5XJGER\">サービス状態の確認方法</h3>\n<ul>\n<li>Linux の場合\n<ul>\n<li>sudo systemctl status mackerel-agent\n<ul>\n<li>「Active: active (running)」になっているか</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Windows の場合\n<ul>\n<li>コントロールパネル &gt; 管理ツール &gt; サービス\n<ul>\n<li>mackerel-agent の状態が「実行中」になっているか</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0CHR6MXCV1AWX30RD\">次に行うこと</h3>\n<ul>\n<li>サービスの起動に失敗したり、サービスを起動してもすぐに停止したりする場合\n<ul>\n<li>「設定内容に問題がないか」以降を確認してください。</li>\n</ul>\n</li>\n<li>サービスが起動しているにもかかわらず、ホストが登録されない場合\n<ul>\n<li>mackerel-agent.conf に記載されている <a href=\"https://mackerel.io/ja/docs/entry/spec/agent#config-file-apikey\">apikey</a> の値が、登録先オーガニゼーションの API キーであるかを確認してください。異なる場合は API キーを登録先オーガニゼーションで発行した正しいものに差し替え、mackerel-agent を再起動してください。\n<ul>\n<li>API キーには Read および Write 権限が必要です。</li>\n<li>API キーが異なる場合、別のオーガニゼーションにホストが登録されている可能性があります。誤って登録されたホストは退役してください。</li>\n</ul>\n</li>\n<li>API キーに問題がない場合は「エラーが発生していないか」以降を確認してださい。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"h_01J9XD23B0S2MDG18T33MRRN4E\">設定内容に問題がないか</h2>\n<p>mackerel-agent.conf ファイルの内容に問題がある場合はサービスの起動に失敗します。以下の手順でmackerel-agent.conf ファイルの内容をチェックしてください。</p>\n<h3 id=\"h_01J9XD23B0NA30ZD896QJVQXYW\">mackerel-agent.conf のチェック方法</h3>\n<ul>\n<li>Linux 環境\n<ul>\n<li>sudo mackerel-agent configtest</li>\n</ul>\n</li>\n<li>Windows 環境\n<ol>\n<li>コマンドプロンプトを起動</li>\n<li>ディレクトリの移動\n<ul>\n<li>mackerel-agent のバージョンが 0.68.0 以降の場合\n<ul>\n<li>cd /d C:\\Program Files\\Mackerel\\mackerel-agent</li>\n</ul>\n</li>\n<li>mackerel-agent のバージョンが 0.67.1 以前の場合\n<ul>\n<li>cd /d C:\\Program Files (x86)\\Mackerel\\mackerel-agent</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>mackerel-agent configtest を実行</li>\n</ol>\n</li>\n</ul>\n<p>設定内容に問題がない場合は SUCCESS と出力されます。設定内容に問題がある場合は failed to test config に続いてエラーメッセージが表示されますので、エラーメッセージに従ってファイルの内容を修正し、mackerel-agent の起動をお試しください。</p>\n<h2 id=\"h_01J9XD23B0CHPJ3GZCQP98VWH5\">通信が許可されているか</h2>\n<p>mackerel-agent は「 <a href=\"https://support.mackerel.io/hc/ja/articles/360039633271\">サービスがホストされているIPアドレスとポート番号を教えて下さい</a>」に記載の IP アドレスに対して、443 番ポートの通信を行います。通信できない場合はホストの登録ができませんので、通信を許可してください。</p>\n<h2 id=\"h_01J9XD23B0G7JAYGNQJSREN0T6\">エラーが発生していないか</h2>\n<p>ここまでの内容で解決できない場合は「 <a href=\"https://support.mackerel.io/hc/ja/articles/27693101934873-mackerel-agent%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\">mackerel-agentのログを取得する</a>」の内容を参考に mackerel-agent のログを確認してください。後述のエラーメッセージを含むログが出力されている場合は、エラーの内容に応じた対処を行ってください。</p>\n<h3 id=\"h_01J9XD23B0CBWBC4H8114JX69Q\">ホスト ID が重複している</h3>\n<ul>\n<li>エラーメッセージ\n<ul>\n<li>failed to find this host on mackerel (You may want to delete file \" <em>idファイルのパス</em>\" to register this host to an another organization)</li>\n</ul>\n</li>\n<li> 原因\n<ul>\n<li>Mackerel がホストを識別するための id は、ホストの初回登録時にサーバーにファイルとして保存されます。一度退役したホストを id ファイルが残ったままで再度ホスト登録する場合や、すでにホストとして登録済みのサーバーを複製して、別のホストとして登録する場合などに発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>id ファイルを削除して mackerel-agent を再起動します（新規のホストとして登録されます）。id ファイルの保存場所は以下の通りです。\n<ul>\n<li>Linux の場合\n<ul>\n<li>/var/lib/mackerel-agent/id</li>\n</ul>\n</li>\n<li>Windows の場合\n<ul>\n<li>mackerel-agent バージョン 0.68.0 以降\n<ul>\n<li>C:\\Program Files\\Mackerel\\mackerel-agent\\id</li>\n</ul>\n</li>\n<li>mackerel-agent バージョン 0.67.1 以前\n<ul>\n<li>C:\\Program Files (x86)\\Mackerel\\mackerel-agent\\id</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0K0CE38HGP4CATGGW\">ホスト ID と custom_identifier の不整合が発生している</h3>\n<ul>\n<li> エラーメッセージ\n<ul>\n<li>custom identifiers mismatch: this host = \" <em>custom_identifier</em>\", the host whose id is \" <em>既存ホストの ID</em>\" on mackerel.io = \" <em>別ホストの custom_identifier</em>\" (File \" <em>idファイルのパス</em>\" may be copied from another host. Try deleting it and restarting agent)</li>\n</ul>\n</li>\n<li>原因\n<ul>\n<li>Amazon EC2、Azure Virtual Machine、Google Compute Engine において、ホスト登録を行ったことがある仮想マシンの複製や、ホスト登録を行ったことがある仮想マシンのイメージから仮想マシンを起動して、新たにホスト登録を行おうとした場合に発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>id ファイルを削除して mackerel-agent を再起動します（新規のホストとして登録されます）。</li>\n<li>ホスト登録を行ったことがあるサーバーを複製する際は、複製されたサーバーの id ファイルを削除してから mackerel-agent を起動するようにしてください。</li>\n<li>ホスト登録を行ったことがあるサーバーのマシンイメージを作成する際は、マシンイメージに id ファイルを含まないように注意してください。</li>\n</ul>\n</li>\n<li>custom_identifier とは\n<ul>\n<li>Amazon EC2、Azure Virtual Machine、Google Compute Engine の仮想マシンでは、ホスト ID の他にホストごとに一意の custom_identifier という識別子が生成されます。custom_identifier にはインスタンス ID など固有の情報が値として使用されます。そのため、複製されたサーバーの custom_identifier は必ず複製元のサーバーと異なる値になります。Mackerel ではホスト ID と custom_identifier を紐づけて管理しており、複製元のサーバーの id ファイルが残っていると、ホスト ID と custom_identifier の不整合が発生し、mackerel-agent の起動に失敗します。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0D0JCF8RNP36HA9FD\">名前解決に失敗している</h3>\n<ul>\n<li>エラーメッセージ\n<ul>\n<li>dial tcp: lookup api.mackerelio.com: no such host</li>\n<li>dial tcp: lookup api.mackerelio.com on <em>IPアドレス</em>:53: server misbehaving</li>\n</ul>\n</li>\n<li>原因\n<ul>\n<li>mackerel-agent の通信先である Mackerel の API エンドポイントの名前解決に失敗した場合に発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>mackerel-agent が Mackerel の API エンドポイントの名前解決を行える状態にしてください。</li>\n<li>Mackerel の API エンドポイントは以下の通りです。\n<ul>\n<li>api.mackerelio.com</li>\n<li>kcps-mackerel.io（KCPS 環境）</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0CH5MTS019DFX2RYP\">ネットワークに問題がある</h3>\n<ul>\n<li>エラーメッセージ\n<ul>\n<li>context deadline exceeded (Client.Timeout exceeded while awaiting headers)</li>\n</ul>\n</li>\n<li>原因\n<ul>\n<li>mackerel-agent から Mackerel の API エンドポイントに対する通信がタイムアウトした場合に発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>Mackerel の API エンドポイントに対して通信可能な状態か確認してください。プロキシサーバーが必要なネットワーク環境においては、mackerel-agent.conf の <a href=\"https://mackerel.io/ja/docs/entry/spec/agent#config-file-proxy\">proxy</a> を設定してください。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0P1D007S345FDNGSE\">プロキシサーバーとの通信に失敗している</h3>\n<ul>\n<li>エラーメッセージ\n<ul>\n<li>proxyconnect tcp: dial tcp: lookup <em>プロキシサーバー名</em>: no such host</li>\n<li>proxyconnect tcp: dial tcp <em>IPアドレス</em>: <em>ポート番号</em>: connect: connection refused</li>\n</ul>\n</li>\n<li>原因\n<ul>\n<li>mackerel-agent がプロキシサーバーとの通信に失敗した場合に発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>mackerel-agent.conf の <a href=\"https://mackerel.io/ja/docs/entry/spec/agent#config-file-proxy\">proxy</a> に指定したプロキシサーバーの名前解決ができるか、プロキシサーバーが停止していないかなど、プロキシサーバーが利用可能な状態であることを確認してください。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"h_01J9XD23B0TJQX75988GK0QMM8\">API キーが正しくない</h3>\n<ul>\n<li>エラーメッセージ\n<ul>\n<li>API request failed: Authentication failed. Please try with valid Api Key.</li>\n</ul>\n</li>\n<li>原因\n<ul>\n<li>API キーが正しくない場合に発生します。</li>\n</ul>\n</li>\n<li>対処方法\n<ul>\n<li>\n<p>mackerel-agent.conf に 記載されている <a href=\"https://mackerel.io/ja/docs/entry/spec/agent#config-file-apikey\">apikey</a> の値が、登録先オーガニゼーションの API キーであるかを確認してください。異なる場合は API キーを登録先オーガニゼーションで発行した正しいものに差し替え、mackerel-agent を再起動してください。</p>\n<ul>\n<li>API キーには Read および Write 権限が必要です。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>"
  }
}
